# Terraform recipes

# Workspaces
workspace env:
  terraform workspace select {{ lowercase(env) }}

# Plan Terraform changes
[group('apply')]
plan env +args="":
  terraform plan --var="environment={{ env }}" {{ args }}

# Apply Terraform changes
[group('apply')]
apply env +args="":
  terraform apply --var="environment={{ env }}" {{ args }}

# Apply all changes
[group('apply')]
init-apply env +args="": (init env '--reconfigure') (apply env args)

# Destroy infrastructure (with confirmation)
[group('apply')]
destroy env:
  @echo "⚠️  WARNING: This will destroy infrastructure!"
  terraform destroy --var="environment={{ env }}"

# Output
[group('apply')]
output env +args="":
  terraform output

# Format Terraform files
[group('lint')]
fmt:
  terraform fmt --recursive

# Validate Terraform configuration
[group('lint')]
validate:
  terraform validate

# Lint Terraform configuration
[group('lint')]
lint:
  tflint --init
  tflint --recursive

# Checkov
[group('lint')]
checkov:
  checkov --directory . --framework terraform

# Trivy
[group('lint')]
trivy:
  trivy --exit-code 1 --severity HIGH,CRITICAL config .

# Check
[group('lint')]
check: fmt validate lint checkov trivy
