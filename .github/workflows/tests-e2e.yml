---
name: "[template] End-to-End Tests"

on:
  workflow_call:
  pull_request:
    branches: [main]

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    #env:
    #  LOCALSTACK_AUTH_TOKEN: ${{ secrets.LOCALSTACK_AUTH_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          uv sync --all-packages --all-extras

      - name: Install Playwright browsers
        run: uv run playwright install --with-deps

      - name: Install Just
        uses: extractions/setup-just@v3

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.1

      - name: Set up Docker compose
        uses: docker/setup-compose-action@v1

      - name: Start LocalStack
        run: |
          just infra::localstack-start

      - name: Bootstrap localstack
        env:
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: eu-west-1
          AWS_ENDPOINT_URL: http://localhost:4566
        run: |
          just infra::bootstrap::init local
          just infra::bootstrap::apply local --auto-approve

      - name: Provision Global Infrastructure
        env:
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: eu-west-1
          AWS_ENDPOINT_URL: http://localhost:4566
        run: |
          just infra::global::init local
          just infra::global::apply local --auto-approve

      - name: Build Services
        env:
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: eu-west-1
          AWS_ENDPOINT_URL: http://localhost:4566
        run: |
          just services::build-all

      - name: Provision Services Infrastructure
        env:
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: eu-west-1
          AWS_ENDPOINT_URL: http://localhost:4566
        run: |
          just infra::services::init local
          just infra::services::apply local --auto-approve

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install Frontend Dependencies
        run: just app::install

      - name: Start Frontend
        run: |
          # Get API Gateway ID from Terraform
          cd infra/services
          API_ID=$(terraform output -raw api_gateway_id)
          echo "API ID: $API_ID"

          # Construct LocalStack path-style URL
          # http://localhost:4566/restapis/{api_id}/{stage}/_user_request_
          # Assuming stage is v1
          LOCAL_API_URL="http://localhost:4566/restapis/$API_ID/v1/_user_request_"

          # Export to GITHUB_ENV for subsequent steps
          echo "VITE_API_URL=$LOCAL_API_URL" >> $GITHUB_ENV

          echo "Starting Frontend with API URL: $LOCAL_API_URL"

          # Start frontend in background
          cd ../..
          export VITE_API_URL=$LOCAL_API_URL
          cd app
          nohup bun run dev > frontend.log 2>&1 &

          # Wait for server to be ready
          bun x wait-on tcp:5173 --timeout 30000

      - name: Run Functional Tests
        id: functional-tests
        env:
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: eu-west-1
          AWS_ENDPOINT_URL: http://localhost:4566
          VITE_API_URL: ${{ env.VITE_API_URL }}
        run: |
          # Run tests and capture output, allow failure to process it
          set +e
          just tests::run > test_output.txt 2>&1
          EXIT_CODE=$?
          set -e

          # Print output for logs
          cat test_output.txt

          if [ $EXIT_CODE -eq 0 ]; then
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            exit $EXIT_CODE
          fi

      - name: Publish Test Report
        if: always()
        run: |
          # Parse output and generate Markdown summary
          python3 -c "
          import re
          import os

          summary_path = os.environ.get('GITHUB_STEP_SUMMARY')
          if summary_path and os.path.exists('test_output.txt'):
              with open(summary_path, 'a') as report:
                  report.write('## Functional Test Results\n')
                  report.write('| User Story | Test Case | Result |\n')
                  report.write('| :--- | :--- | :--- |\n')

                  with open('test_output.txt', 'r') as f:
                      for line in f:
                          m = re.search(r'(us_\d+)_test\.py::(\w+)::([\w\[\]]+)\s+(PASSED|FAILED|SKIPPED|XFAIL|XPASS)', line)
                          if m:
                              us, cls, test, status = m.groups()
                              us_fmt = us.upper().replace('_', '-')
                              icon = '✅' if status == 'PASSED' or status == 'XPASS' else '❌' if status == 'FAILED' else '⚠️'
                              report.write(f'| {us_fmt} | {test} | {icon} {status} |\n')
          "

      - name: Stop LocalStack
        if: always()
        run: |
          just infra::localstack-stop
